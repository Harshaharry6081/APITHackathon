<!DOCTYPE html>
<html>
<head>
  <title>AI Early Warning Dashboard - Andhra Pradesh School Education</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      color: #333;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 5px;
    }
    
    .header p {
      color: #666;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-card .value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card.high-risk .value { color: #e74c3c; }
    .stat-card.moderate-risk .value { color: #f39c12; }
    .stat-card.low-risk .value { color: #27ae60; }
    .stat-card.total .value { color: #3498db; }
    
    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .panel {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .panel h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    
    .student-list {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .student-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.2s;
    }
    
    .student-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: #667eea;
    }
    
    .student-card.high-risk { border-left: 4px solid #e74c3c; }
    .student-card.moderate-risk { border-left: 4px solid #f39c12; }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .student-id {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    
    .risk-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    
    .risk-badge.high { background: #e74c3c; }
    .risk-badge.moderate { background: #f39c12; }
    
    .student-info {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .risk-reasons {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
    
    .risk-reasons ul {
      list-style: none;
      font-size: 12px;
    }
    
    .risk-reasons li {
      padding: 3px 0;
      color: #555;
    }
    
    .risk-reasons li:before {
      content: "‚ö† ";
      color: #e74c3c;
      margin-right: 5px;
    }
    
    .action-buttons {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    button.secondary {
      background: #95a5a6;
    }
    
    button.secondary:hover {
      background: #7f8c8d;
    }
    
    .controls {
      margin-bottom: 20px;
    }
    
    select, input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
      font-size: 14px;
    }
    
    .model-metrics {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .model-metrics h4 {
      color: #27ae60;
      margin-bottom: 10px;
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 13px;
    }
    
    .metric-value {
      font-weight: bold;
      color: #27ae60;
    }
    
    .intervention-form {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    
    .intervention-form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px 0;
      font-family: inherit;
      resize: vertical;
    }
    
    #output {
      background: white;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üéì AI Early Warning System</h1>
    <p>Student Dropout Prevention Dashboard - Andhra Pradesh School Education Department</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card total">
      <h3>Total Students Monitored</h3>
      <div class="value" id="totalStudents">-</div>
    </div>
    <div class="stat-card high-risk">
      <h3>High Risk Students</h3>
      <div class="value" id="highRisk">-</div>
    </div>
    <div class="stat-card moderate-risk">
      <h3>Moderate Risk Students</h3>
      <div class="value" id="moderateRisk">-</div>
    </div>
    <div class="stat-card low-risk">
      <h3>Low Risk Students</h3>
      <div class="value" id="lowRisk">-</div>
    </div>
  </div>

  <div class="main-content">
    <div class="panel">
      <h2>üö® Priority At-Risk Students</h2>
      <div class="controls">
        <select id="districtFilter">
          <option value="all">All Districts</option>
          <option value="Visakhapatnam">Visakhapatnam</option>
          <option value="Guntur">Guntur</option>
          <option value="Krishna">Krishna</option>
        </select>
        <select id="riskFilter">
          <option value="50">Risk Threshold: 50%+</option>
          <option value="70">Risk Threshold: 70%+</option>
          <option value="80">Risk Threshold: 80%+</option>
        </select>
        <button onclick="loadAtRiskStudents()">Refresh Data</button>
      </div>
      <div class="student-list" id="studentList">
        <p>Loading students...</p>
      </div>
    </div>

    <div class="panel">
      <h2>üìä System Performance</h2>
      <div class="model-metrics" id="modelMetrics">
        <h4>‚úÖ PoC Success Criteria</h4>
        <div class="metric-row">
          <span>Model Accuracy:</span>
          <span class="metric-value" id="accuracy">-</span>
        </div>
        <div class="metric-row">
          <span>Inclusion Error:</span>
          <span class="metric-value" id="inclusionError">-</span>
        </div>
        <div class="metric-row">
          <span>Exclusion Error:</span>
          <span class="metric-value" id="exclusionError">-</span>
        </div>
        <div class="metric-row">
          <span>Target Met:</span>
          <span class="metric-value" id="targetMet">-</span>
        </div>
      </div>

      <h3 style="margin-top: 20px; margin-bottom: 15px;">üéØ Log Intervention</h3>
      <div class="intervention-form">
        <input type="text" id="interventionStudent" placeholder="Student ID (e.g., ST001)" style="width: 100%;">
        <textarea id="interventionAction" rows="3" placeholder="Describe intervention action..."></textarea>
        <input type="text" id="interventionOfficer" placeholder="Your name" style="width: 100%;">
        <button onclick="logIntervention()" style="width: 100%; margin-top: 10px;">Record Intervention</button>
      </div>

      <div id="output"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:3000";
    let allStudents = [];

    // Load model metrics
    async function loadModelMetrics() {
      try {
        const res = await fetch(`${API_BASE}/model/metrics`);
        const data = await res.json();
        
        document.getElementById("accuracy").textContent = 
          `${(data.model_accuracy * 100).toFixed(1)}%`;
        document.getElementById("inclusionError").textContent = 
          `${data.inclusion_error.toFixed(1)}% (<80% ‚úì)`;
        document.getElementById("exclusionError").textContent = 
          `${data.exclusion_error.toFixed(1)}% (<20% ‚úì)`;
        document.getElementById("targetMet").textContent = 
          data.poc_criteria_met ? "Yes ‚úì" : "No ‚úó";
      } catch (error) {
        console.error("Failed to load metrics:", error);
      }
    }

    // Load at-risk students
    async function loadAtRiskStudents() {
      try {
        const threshold = document.getElementById("riskFilter").value;
        const res = await fetch(`${API_BASE}/students/at-risk/all?threshold=${threshold}`);
        const data = await res.json();
        
        allStudents = data.students;
        displayStudents(allStudents);
        updateStats(allStudents);
      } catch (error) {
        document.getElementById("studentList").innerHTML = 
          `<p style="color: #e74c3c;">‚ö† Error: Make sure the server is running on port 3000</p>`;
      }
    }

    // Display students
    function displayStudents(students) {
      const districtFilter = document.getElementById("districtFilter").value;
      const filtered = districtFilter === "all" 
        ? students 
        : students.filter(s => s.district === districtFilter);

      const html = filtered.map(student => `
        <div class="student-card ${student.risk.toLowerCase()}-risk">
          <div class="student-header">
            <span class="student-id">${student.id}</span>
            <span class="risk-badge ${student.risk.toLowerCase()}">${student.risk} (${student.probability}%)</span>
          </div>
          <div class="student-info">
            üìç ${student.district} | Grade ${student.grade}
          </div>
          <div class="risk-reasons">
            <strong>Risk Factors:</strong>
            <ul>
              ${student.reasons.slice(0, 3).map(r => `<li>${r}</li>`).join('')}
            </ul>
          </div>
          <div class="action-buttons">
            <button onclick="viewStudent('${student.id}')">View Details</button>
            <button class="secondary" onclick="quickIntervention('${student.id}')">Quick Action</button>
          </div>
        </div>
      `).join('');

      document.getElementById("studentList").innerHTML = 
        html || '<p>No students match the current filters.</p>';
    }

    // Update statistics
    function updateStats(students) {
      document.getElementById("totalStudents").textContent = students.length;
      document.getElementById("highRisk").textContent = 
        students.filter(s => s.risk === "High").length;
      document.getElementById("moderateRisk").textContent = 
        students.filter(s => s.risk === "Moderate").length;
      document.getElementById("lowRisk").textContent = 
        students.filter(s => s.risk === "Low").length;
    }

    // View student details
    async function viewStudent(studentId) {
      try {
        const res = await fetch(`${API_BASE}/students/${studentId}/risk`);
        const data = await res.json();
        
        document.getElementById("output").innerHTML = 
          `<strong>Student: ${studentId}</strong><br><br>` +
          `<strong>Risk Level:</strong> ${data.risk} (${data.probability}%)<br><br>` +
          `<strong>Risk Factors:</strong><br>${data.reasons.join('<br>')}<br><br>` +
          `<strong>Recommended Actions:</strong><br>${data.recommendations.join('<br>')}`;
      } catch (error) {
        document.getElementById("output").textContent = "Error loading student details";
      }
    }

    // Quick intervention
    function quickIntervention(studentId) {
      document.getElementById("interventionStudent").value = studentId;
      document.getElementById("interventionAction").value = "Parent meeting scheduled";
      document.getElementById("interventionAction").focus();
    }

    // Log intervention
    async function logIntervention() {
      const studentId = document.getElementById("interventionStudent").value;
      const action = document.getElementById("interventionAction").value;
      const officer = document.getElementById("interventionOfficer").value;

      if (!studentId || !action) {
        alert("Please fill in student ID and action");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/interventions`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            studentId, 
            action,
            actionedBy: officer || "Teacher",
            timestamp: new Date().toISOString()
          })
        });
        const data = await res.json();
        
        document.getElementById("output").innerHTML = 
          `<strong style="color: #27ae60;">‚úì Intervention Recorded</strong><br><br>` +
          JSON.stringify(data, null, 2);
        
        // Clear form
        document.getElementById("interventionStudent").value = "";
        document.getElementById("interventionAction").value = "";
      } catch (error) {
        document.getElementById("output").textContent = "Error logging intervention";
      }
    }

    // District filter change
    document.getElementById("districtFilter").addEventListener("change", () => {
      displayStudents(allStudents);
    });

    // Risk filter change
    document.getElementById("riskFilter").addEventListener("change", () => {
      loadAtRiskStudents();
    });

    // Initialize dashboard
    loadModelMetrics();
    loadAtRiskStudents();
  </script>
</body>
</html>
